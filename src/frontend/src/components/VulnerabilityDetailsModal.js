import React from 'react';
import './VulnerabilityDetailsModal.css';

/**
 * Modal component to display detailed vulnerability information
 * including step-by-step remediation instructions
 */
function VulnerabilityDetailsModal({ vulnerability, onClose }) {
  if (!vulnerability) return null;

  const getSeverityClass = (severity) => {
    const severityLower = severity?.toLowerCase() || '';
    switch (severityLower) {
      case 'critical':
        return 'severity-critical';
      case 'high':
        return 'severity-high';
      case 'medium':
        return 'severity-medium';
      case 'low':
        return 'severity-low';
      default:
        return 'severity-unknown';
    }
  };

  // Parse remediation text into steps if it contains numbered lists
  const parseRemediationSteps = (remediation) => {
    if (!remediation) return null;

    // Check if remediation contains numbered steps (1., 2., etc.)
    const stepPattern = /(\d+\.\s+[^\n]+)/g;
    const steps = remediation.match(stepPattern);

    if (steps && steps.length > 1) {
      return steps.map(step => step.replace(/^\d+\.\s+/, '').trim());
    }

    return null;
  };

  const remediationSteps = parseRemediationSteps(vulnerability.recommendation || vulnerability.remediation);

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2 className="modal-title">Vulnerability Details</h2>
          <button className="modal-close-btn" onClick={onClose} aria-label="Close modal">
            &times;
          </button>
        </div>

        <div className="modal-body">
          {/* Severity Badge */}
          <div className="detail-section">
            <div className="detail-row">
              <span className="detail-label">Severity:</span>
              <span className={`severity-badge ${getSeverityClass(vulnerability.severity)}`}>
                {vulnerability.severity || 'Unknown'}
              </span>
            </div>
          </div>

          {/* Basic Information */}
          <div className="detail-section">
            <h3 className="section-title">Overview</h3>
            <div className="detail-row">
              <span className="detail-label">ID:</span>
              <code className="detail-value">{vulnerability.id}</code>
            </div>
            <div className="detail-row">
              <span className="detail-label">Category:</span>
              <span className="detail-value">{vulnerability.category || 'N/A'}</span>
            </div>
            <div className="detail-row">
              <span className="detail-label">Title:</span>
              <span className="detail-value">{vulnerability.title || 'Untitled Issue'}</span>
            </div>
            {vulnerability.affected_item && (
              <div className="detail-row">
                <span className="detail-label">Affected Item:</span>
                <code className="detail-value">{vulnerability.affected_item}</code>
              </div>
            )}
            {vulnerability.timestamp && (
              <div className="detail-row">
                <span className="detail-label">Detected:</span>
                <span className="detail-value">{new Date(vulnerability.timestamp).toLocaleString()}</span>
              </div>
            )}
          </div>

          {/* Description */}
          <div className="detail-section">
            <h3 className="section-title">Description</h3>
            <p className="detail-text">{vulnerability.description || 'No description available'}</p>
          </div>

          {/* Remediation Steps */}
          <div className="detail-section remediation-section">
            <h3 className="section-title">Remediation</h3>
            {remediationSteps ? (
              <ol className="remediation-steps">
                {remediationSteps.map((step, index) => (
                  <li key={index} className="remediation-step">
                    {step}
                  </li>
                ))}
              </ol>
            ) : (
              <p className="detail-text">
                {vulnerability.recommendation || vulnerability.remediation || 'No remediation information available'}
              </p>
            )}
          </div>

          {/* References */}
          {vulnerability.references && vulnerability.references.length > 0 && (
            <div className="detail-section">
              <h3 className="section-title">References</h3>
              <ul className="references-list">
                {vulnerability.references.map((ref, index) => (
                  <li key={index} className="reference-item">
                    <a href={ref} target="_blank" rel="noopener noreferrer" className="reference-link">
                      {ref}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}

          {/* Risk Information */}
          <div className="detail-section risk-info">
            <h3 className="section-title">Risk Assessment</h3>
            <div className="risk-grid">
              <div className="risk-item">
                <span className="risk-label">Impact:</span>
                <span className="risk-value">
                  {vulnerability.severity === 'critical' || vulnerability.severity === 'Critical'
                    ? 'Very High - Immediate action required'
                    : vulnerability.severity === 'high' || vulnerability.severity === 'High'
                    ? 'High - Should be addressed soon'
                    : vulnerability.severity === 'medium' || vulnerability.severity === 'Medium'
                    ? 'Medium - Address when possible'
                    : 'Low - Minor issue or improvement'}
                </span>
              </div>
              <div className="risk-item">
                <span className="risk-label">Status:</span>
                <span className="risk-value status-open">Open</span>
              </div>
            </div>
          </div>
        </div>

        <div className="modal-footer">
          <button className="btn btn-secondary" onClick={onClose}>
            Close
          </button>
        </div>
      </div>
    </div>
  );
}

export default VulnerabilityDetailsModal;
