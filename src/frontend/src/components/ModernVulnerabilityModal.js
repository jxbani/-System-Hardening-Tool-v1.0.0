import React, { useState, useEffect } from 'react';
import './ModernVulnerabilityModal.css';

function ModernVulnerabilityModal({ vulnerability, onClose }) {
  const [activeTab, setActiveTab] = useState('overview');
  const [copySuccess, setCopySuccess] = useState('');

  // Handle escape key to close modal
  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape') {
        onClose();
      }
    };

    document.addEventListener('keydown', handleEscape);
    document.body.style.overflow = 'hidden';

    return () => {
      document.removeEventListener('keydown', handleEscape);
      document.body.style.overflow = 'unset';
    };
  }, [onClose]);

  if (!vulnerability) return null;

  /**
   * Get severity information
   */
  const getSeverityInfo = (severity) => {
    const severityLower = severity?.toLowerCase() || '';
    switch (severityLower) {
      case 'critical':
        return {
          class: 'severity-critical',
          color: '#FF3366',
          icon: 'ðŸ”´',
          impact: 'Very High - Immediate action required',
          description: 'Critical vulnerabilities pose an immediate threat to system security and must be addressed urgently.'
        };
      case 'high':
        return {
          class: 'severity-high',
          color: '#FF6B35',
          icon: 'ðŸŸ ',
          impact: 'High - Should be addressed soon',
          description: 'High-severity issues represent significant security risks and should be remediated promptly.'
        };
      case 'medium':
        return {
          class: 'severity-medium',
          color: '#FFA500',
          icon: 'ðŸŸ¡',
          impact: 'Medium - Address when possible',
          description: 'Medium-severity vulnerabilities should be addressed in the next maintenance window.'
        };
      case 'low':
        return {
          class: 'severity-low',
          color: '#4ECDC4',
          icon: 'ðŸŸ¢',
          impact: 'Low - Minor issue or improvement',
          description: 'Low-severity issues represent minor security improvements and can be scheduled for future updates.'
        };
      default:
        return {
          class: 'severity-unknown',
          color: '#95A3B3',
          icon: 'âšª',
          impact: 'Unknown impact',
          description: 'Severity level not determined.'
        };
    }
  };

  /**
   * Parse remediation into steps
   */
  const parseRemediationSteps = (remediation) => {
    if (!remediation) return null;

    // Try to parse numbered steps
    const stepPattern = /(\d+\.\s+[^\n]+)/g;
    const steps = remediation.match(stepPattern);

    if (steps && steps.length > 1) {
      return steps.map(step => step.replace(/^\d+\.\s+/, '').trim());
    }

    // Try to split by newlines
    const lines = remediation.split('\n').filter(line => line.trim());
    if (lines.length > 1) {
      return lines;
    }

    return null;
  };

  /**
   * Extract code blocks from text
   */
  const extractCodeBlocks = (text) => {
    if (!text) return [];

    const codeBlockPattern = /```([^\n]*)\n([\s\S]*?)```/g;
    const matches = [];
    let match;

    while ((match = codeBlockPattern.exec(text)) !== null) {
      matches.push({
        language: match[1] || 'bash',
        code: match[2].trim()
      });
    }

    return matches;
  };

  /**
   * Copy text to clipboard
   */
  const copyToClipboard = async (text, label = 'Text') => {
    try {
      await navigator.clipboard.writeText(text);
      setCopySuccess(label);
      setTimeout(() => setCopySuccess(''), 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  const severityInfo = getSeverityInfo(vulnerability.severity);
  const remediationSteps = parseRemediationSteps(vulnerability.recommendation || vulnerability.remediation);
  const codeBlocks = extractCodeBlocks(vulnerability.recommendation || vulnerability.remediation || '');

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-container" onClick={(e) => e.stopPropagation()}>

        {/* Modal Header */}
        <div className="modal-header">
          <div className="modal-header-content">
            <div className="modal-title-section">
              <div className={`severity-indicator ${severityInfo.class}`}>
                <span className="severity-icon">{severityInfo.icon}</span>
                <span className="severity-label">{vulnerability.severity || 'Unknown'}</span>
              </div>
              <h2 className="modal-title">{vulnerability.title || 'Vulnerability Details'}</h2>
            </div>

            <button className="modal-close-btn" onClick={onClose} aria-label="Close modal">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>

          {/* Tabs */}
          <div className="modal-tabs">
            <button
              className={`tab-button ${activeTab === 'overview' ? 'active' : ''}`}
              onClick={() => setActiveTab('overview')}
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0L0 4v6c0 4.97 3.44 9.62 8 10.75C12.56 19.62 16 14.97 16 10V4L8 0z"/>
              </svg>
              <span>Overview</span>
            </button>
            <button
              className={`tab-button ${activeTab === 'remediation' ? 'active' : ''}`}
              onClick={() => setActiveTab('remediation')}
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M15.5 7l-1.4-1.4-5.8 5.8-3.3-3.3L3.6 9.5l4.7 4.7L15.5 7z"/>
              </svg>
              <span>Remediation</span>
            </button>
            <button
              className={`tab-button ${activeTab === 'details' ? 'active' : ''}`}
              onClick={() => setActiveTab('details')}
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <circle cx="8" cy="8" r="7" fill="none" stroke="currentColor" strokeWidth="1.5"/>
                <path d="M8 6v6M8 4v1"/>
              </svg>
              <span>Details</span>
            </button>
          </div>
        </div>

        {/* Modal Body */}
        <div className="modal-body">

          {/* Overview Tab */}
          {activeTab === 'overview' && (
            <div className="tab-content tab-overview">

              {/* Risk Assessment */}
              <div className="info-section">
                <h3 className="section-title">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10 0L2 4v6c0 4.97 3.44 9.62 8 10.75C14.56 19.62 18 14.97 18 10V4L10 0z"/>
                  </svg>
                  <span>Risk Assessment</span>
                </h3>
                <div className="risk-card" style={{ borderLeftColor: severityInfo.color }}>
                  <div className="risk-header">
                    <span className="risk-level">{severityInfo.impact}</span>
                  </div>
                  <p className="risk-description">{severityInfo.description}</p>
                </div>
              </div>

              {/* Description */}
              <div className="info-section">
                <h3 className="section-title">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M0 0h20v4H0V0zm0 6h20v4H0V6zm0 6h14v4H0v-4z"/>
                  </svg>
                  <span>Description</span>
                </h3>
                <div className="description-box">
                  <p>{vulnerability.description || 'No description available'}</p>
                </div>
              </div>

              {/* Quick Info Grid */}
              <div className="info-section">
                <h3 className="section-title">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <rect width="8" height="8" rx="1"/>
                    <rect x="11" width="8" height="8" rx="1"/>
                    <rect y="11" width="8" height="8" rx="1"/>
                    <rect x="11" y="11" width="8" height="8" rx="1"/>
                  </svg>
                  <span>Quick Information</span>
                </h3>
                <div className="info-grid">
                  <div className="info-card">
                    <div className="info-label">Vulnerability ID</div>
                    <div className="info-value">
                      <code>{vulnerability.id}</code>
                      <button
                        className="btn-copy-inline"
                        onClick={() => copyToClipboard(vulnerability.id, 'ID')}
                        title="Copy ID"
                      >
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                          <path d="M10 0H2C1.4 0 1 .4 1 1v8h1V1h8V0zM12 2H4c-.6 0-1 .4-1 1v10c0 .6.4 1 1 1h8c.6 0 1-.4 1-1V3c0-.6-.4-1-1-1zm0 11H4V3h8v10z"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div className="info-card">
                    <div className="info-label">Category</div>
                    <div className="info-value">{vulnerability.category || 'N/A'}</div>
                  </div>
                  {vulnerability.affected_item && (
                    <div className="info-card">
                      <div className="info-label">Affected Item</div>
                      <div className="info-value">
                        <code>{vulnerability.affected_item}</code>
                      </div>
                    </div>
                  )}
                  {vulnerability.timestamp && (
                    <div className="info-card">
                      <div className="info-label">Detected</div>
                      <div className="info-value">
                        {new Date(vulnerability.timestamp).toLocaleString()}
                      </div>
                    </div>
                  )}
                </div>
              </div>

            </div>
          )}

          {/* Remediation Tab */}
          {activeTab === 'remediation' && (
            <div className="tab-content tab-remediation">

              {/* Remediation Steps */}
              <div className="info-section">
                <h3 className="section-title">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-2 15l-5-5 1.41-1.41L8 12.17l7.59-7.59L17 6l-9 9z"/>
                  </svg>
                  <span>Remediation Steps</span>
                </h3>

                {remediationSteps ? (
                  <div className="steps-container">
                    {remediationSteps.map((step, index) => (
                      <div key={index} className="remediation-step">
                        <div className="step-number">
                          <span>{index + 1}</span>
                        </div>
                        <div className="step-content">
                          <p>{step}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="remediation-text">
                    <p>{vulnerability.recommendation || vulnerability.remediation || 'No remediation information available'}</p>
                  </div>
                )}
              </div>

              {/* Code Blocks */}
              {codeBlocks.length > 0 && (
                <div className="info-section">
                  <h3 className="section-title">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M6 14l-4-4 4-4 1.4 1.4L4.8 10l2.6 2.6L6 14zm8 0l4-4-4-4-1.4 1.4L15.2 10l-2.6 2.6L14 14z"/>
                    </svg>
                    <span>Command Reference</span>
                  </h3>
                  {codeBlocks.map((block, index) => (
                    <div key={index} className="code-block">
                      <div className="code-header">
                        <span className="code-language">{block.language}</span>
                        <button
                          className="btn-copy"
                          onClick={() => copyToClipboard(block.code, 'Code')}
                        >
                          {copySuccess === 'Code' ? (
                            <>
                              <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                                <path d="M7 0L0 7l7 7 7-7-7-7zm0 12L2 7l5-5 5 5-5 5z"/>
                                <path d="M5 7l2 2 4-4"/>
                              </svg>
                              <span>Copied!</span>
                            </>
                          ) : (
                            <>
                              <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                                <path d="M10 0H2C1.4 0 1 .4 1 1v8h1V1h8V0zM12 2H4c-.6 0-1 .4-1 1v10c0 .6.4 1 1 1h8c.6 0 1-.4 1-1V3c0-.6-.4-1-1-1zm0 11H4V3h8v10z"/>
                              </svg>
                              <span>Copy</span>
                            </>
                          )}
                        </button>
                      </div>
                      <pre className="code-content"><code>{block.code}</code></pre>
                    </div>
                  ))}
                </div>
              )}

              {/* Safety Warning */}
              <div className="warning-box">
                <div className="warning-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                  </svg>
                </div>
                <div className="warning-content">
                  <h4 className="warning-title">Important Safety Notice</h4>
                  <p className="warning-text">
                    Always create a system backup before applying security fixes. Test changes in a non-production environment when possible.
                    Some remediations may require system restart or service interruption.
                  </p>
                </div>
              </div>

            </div>
          )}

          {/* Details Tab */}
          {activeTab === 'details' && (
            <div className="tab-content tab-details">

              {/* Technical Details */}
              <div className="info-section">
                <h3 className="section-title">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M18 2H2C.9 2 0 2.9 0 4v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H2V4h16v12z"/>
                  </svg>
                  <span>Technical Information</span>
                </h3>
                <div className="details-table">
                  <div className="detail-row">
                    <div className="detail-label">Vulnerability ID</div>
                    <div className="detail-value"><code>{vulnerability.id}</code></div>
                  </div>
                  <div className="detail-row">
                    <div className="detail-label">Severity Level</div>
                    <div className="detail-value">
                      <span className={`severity-badge ${severityInfo.class}`}>
                        {vulnerability.severity || 'Unknown'}
                      </span>
                    </div>
                  </div>
                  <div className="detail-row">
                    <div className="detail-label">Category</div>
                    <div className="detail-value">{vulnerability.category || 'N/A'}</div>
                  </div>
                  {vulnerability.affected_item && (
                    <div className="detail-row">
                      <div className="detail-label">Affected Component</div>
                      <div className="detail-value"><code>{vulnerability.affected_item}</code></div>
                    </div>
                  )}
                  {vulnerability.cis_benchmark && (
                    <div className="detail-row">
                      <div className="detail-label">CIS Benchmark</div>
                      <div className="detail-value">
                        <span className="badge badge-info">{vulnerability.cis_benchmark}</span>
                      </div>
                    </div>
                  )}
                  <div className="detail-row">
                    <div className="detail-label">Detection Time</div>
                    <div className="detail-value">
                      {vulnerability.timestamp
                        ? new Date(vulnerability.timestamp).toLocaleString()
                        : 'N/A'}
                    </div>
                  </div>
                  <div className="detail-row">
                    <div className="detail-label">Status</div>
                    <div className="detail-value">
                      <span className="badge badge-warning">Open</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* References */}
              {vulnerability.references && vulnerability.references.length > 0 && (
                <div className="info-section">
                  <h3 className="section-title">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M10 0C4.5 0 0 4.5 0 10s4.5 10 10 10 10-4.5 10-10S15.5 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
                    </svg>
                    <span>External References</span>
                  </h3>
                  <div className="references-list">
                    {vulnerability.references.map((ref, index) => (
                      <a
                        key={index}
                        href={ref}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="reference-link"
                      >
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm3.5 9L8 12.5 4.5 9 6 7.5l1.5 1.5V4h1v5l1.5-1.5L11.5 9z"/>
                        </svg>
                        <span>{ref}</span>
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor" className="external-icon">
                          <path d="M10 0H2C.9 0 0 .9 0 2v8c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V2c0-1.1-.9-2-2-2zm0 10H2V2h8v8z"/>
                          <path d="M7 3v1h2.3L5.6 7.7l.7.7L10 4.7V7h1V3H7z"/>
                        </svg>
                      </a>
                    ))}
                  </div>
                </div>
              )}

            </div>
          )}

        </div>

        {/* Modal Footer */}
        <div className="modal-footer">
          <button className="btn btn-secondary" onClick={onClose}>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm4 10.9L10.9 12 8 9.1 5.1 12 4 10.9 6.9 8 4 5.1 5.1 4 8 6.9 10.9 4 12 5.1 9.1 8 12 10.9z"/>
            </svg>
            <span>Close</span>
          </button>
        </div>

        {/* Copy Success Toast */}
        {copySuccess && (
          <div className="copy-toast">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm-1 12L3 8l1.4-1.4L7 9.2l4.6-4.6L13 6l-6 6z"/>
            </svg>
            <span>{copySuccess} copied to clipboard!</span>
          </div>
        )}

      </div>
    </div>
  );
}

export default ModernVulnerabilityModal;
